---
title: "Processing load data"
output: 
  rmarkdown::html_vignette:
    toc: true 
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{Processing load data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(knitr)
library(antaDraft)
```

## Localisation des données

Afin de rendre le travail reproductible, les données à traiter ont été chargées sur https://archive.org. 
Le code suivant permet de télécharger ces données en local. Attention, l'opération est longue.

Cette étape n'est pas nécessaire si vous avez déjà les données sur votre système de fichier. 
Dans ce cas, modifier la variable `local_zip` pour la faire pointer sur le répertoire où se trouvent 
ces données. 

```{r}
local_zip <- "/Users/davidgohel/Documents/consulting/RTE/load.zip"
```


```{r}
load_dir <- file.path(tempdir(), "load_files" )
load_zip <- file.path(tempdir(), "load.zip" )

if( file.exists(local_zip))
  file.copy(local_zip, load_zip, overwrite = TRUE )

if( !file.exists(load_zip) )
  download.file(url = "https://archive.org/download/RTE_load/load.zip", 
                destfile = load_zip )

if( dir.exists(load_dir) )
  unlink(load_dir, recursive = TRUE, force = TRUE)

utils::unzip(load_zip, exdir = load_dir )
```

Les données sont disponibles dans le répertoire `r load_dir`. Celui ci contient les fichiers suivants :

```{r}
csv_files <- list.files(load_dir, full.names = TRUE, pattern = "\\.csv$")
csv_infos <- file.info(csv_files)[, c(1, 3) ]
row.names(csv_infos) <- NULL
csv_infos$file <- basename(csv_files)

kable(csv_infos)
```

> Le traitement des données de consommation de l'entsoe se décompose en plusieurs étapes.

## Les données brutes

### Importation des données brutes

Il faut tout d'abord importer les données brutes. L'opération importe l'ensemble des fichiers 
`csv` du répertoire et y ajoute la dimension *pays*.

```{r}
load_data <- anta_load_read(data_dir = load_dir )
head(load_data)
```

Les règles d'association des pays sont exprimées dans le fichier `config/load/cty_rules.yml`.
Le fichier est scanné afin de dégager l'ensemble des modalités de `MapCode` nécessaires 
à la création des bonnes valeurs de `AreaTypeCode` et de la colonne `country` (pays).

```{r echo=FALSE}
cty_rules <- system.file(package = "antaDraft", "config", "load", "cty_rules.yml")
cty_rules <- paste0(readLines(cty_rules), collapse = "\n" )
htmltools::tags$pre(cty_rules)
```

### Validation des données brutes

L'opération va ajouter autant de colonnes qu'il y a 
de tests exprimés dans le fichier `config/load/raw_validate.yml`.

Ce fichier décrit les règles de validation de chaque ligne de donnée.

```{r echo=FALSE}
raw_validate <- system.file(package = "antaDraft", "config", "load", "raw_validate.yml")
raw_validate <- paste0(readLines(raw_validate), collapse = "\n" )
htmltools::tags$pre(raw_validate)
```


```{r}
load_data <- augment_validation(load_data)
head(load_data)
```

Afin de réduire la liste des *alertes*, certaines valeurs vont être 
modifiées pour ne pas lever des soucis expliqués par un autre souci.
Ce traitement des *faux positifs* est défini dans le fichier `config/load/raw_fp.yml`. 
Le traitement est ici assez simple: si une donnée n'est pas observée, 
on ne relève pas `IS_FINITE` et `IS_POS`, si une donnée n'est pas finie, 
on ne relève pas `IS_POS`.

```{r echo=FALSE}
agg_fp <- system.file(package = "antaDraft", "config", "load", "raw_fp.yml")
agg_fp <- paste0(readLines(agg_fp), collapse = "\n" )
htmltools::tags$pre(agg_fp)
```

